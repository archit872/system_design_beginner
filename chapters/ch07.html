<!doctype html>
<html lang="en">
<head>
    <base href="https://archit872.github.io/system_design_beginner/"> 
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chapter 7 — Guided Practice: Designing a Simple System</title>
  <meta name="description" content="A step-by-step, end-to-end system design exercise (TinyURL), with requirements, APIs, storage, caching, scaling, reliability, and trade-offs." />
  <meta property="og:title" content="Chapter 7 — Guided Practice: Designing a Simple System" />
  <meta property="og:description" content="Walk through a complete beginner-friendly design, including estimations, data model, components, consistency, availability, and observability." />
  <link rel="stylesheet" href="styles/theme.css" />
  <script defer src="scripts/app.js"></script>
</head>
<body>
  <!-- Canonical Navigation -->
  <nav class="app-nav" aria-label="Primary">
    <a href="index.html">Home</a>
    <a href="chapters/ch01.html">Chapter 1</a>
    <a href="chapters/ch02.html">Chapter 2</a>
    <a href="chapters/ch03.html">Chapter 3</a>
    <a href="chapters/ch04.html">Chapter 4</a>
    <a href="chapters/ch05.html">Chapter 5</a>
    <a href="chapters/ch06.html">Chapter 6</a>
    <a href="chapters/ch07.html" aria-current="page">Chapter 7</a>
    <a href="chapters/ch08.html">Chapter 8</a>
    <a href="chapters/appendix.html">Appendix</a>
    <a href="chapters/glossary.html">Glossary</a>
    <button class="nav-toggle" aria-label="Toggle menu" style="margin-left:auto">☰</button>
  </nav>

  <main>
    <header class="page-hero">
      <p class="badge" style="color:var(--muted);letter-spacing:.08em;">CHAPTER 7</p>
      <h1>Guided Practice — Designing a Simple System</h1>
      <p style="max-width:72ch;margin-top:.5rem">
        It’s time to put the pieces together. We’ll design a production-leaning **URL Shortener (TinyURL)** end to end. You’ll practice the workflow:
        requirements → back-of-the-envelope estimations → APIs → storage and <a href="/chapters/glossary.html#index">indexes</a> →
        <a href="/chapters/glossary.html#cache">caching</a> → <a href="/chapters/glossary.html#load-balancer">load balancing</a> →
        <a href="/chapters/glossary.html#replication">replication</a> → <a href="/chapters/glossary.html#monitoring">observability</a>, with explicit trade-offs.
      </p>
    </header>

    <section aria-labelledby="s71">
      <h2 id="s71">7.1 Choose a Sample Problem</h2>
      <p>
        We’ll focus on a **URL shortener** because it surfaces many core concerns while staying approachable. Alternatives to try later:
        a chat app (WebSockets, ordering) or a tiny Twitter (fanout, timelines). As you read, imagine how choices would differ for those.
      </p>
      <div class="callout info"><strong>Analogy:</strong> A shortener is a post office redirect: you send a letter to a short address; the office looks up the real destination and forwards it efficiently.</div>
    </section>

    <figure aria-labelledby="fig7">
      <svg width="100%" height="280" viewBox="0 0 920 280" role="img">
        <title id="fig7">TinyURL high-level architecture</title>
        <rect x="20" y="30" width="160" height="70" rx="10" fill="#0f141b" stroke="#4cc2ff"/>
        <text x="100" y="70" text-anchor="middle" fill="#e6edf3" font-size="12">Client</text>

        <line x1="180" y1="65" x2="270" y2="65" stroke="#7a87ff"/>
        <polygon points="270,65 262,60 262,70" fill="#7a87ff"/>

        <rect x="270" y="30" width="150" height="70" rx="10" fill="#0f141b" stroke="#4cc2ff"/>
        <text x="345" y="70" text-anchor="middle" fill="#e6edf3" font-size="12">Edge/CDN</text>

        <line x1="420" y1="65" x2="510" y2="65" stroke="#7a87ff"/>
        <polygon points="510,65 502,60 502,70" fill="#7a87ff"/>

        <rect x="510" y="20" width="160" height="90" rx="10" fill="#0f141b" stroke="#4cc2ff"/>
        <text x="590" y="55" text-anchor="middle" fill="#e6edf3" font-size="12">API / Redirect</text>
        <text x="590" y="75" text-anchor="middle" fill="#9fb0c3" font-size="10">LB + App x N</text>

        <line x1="590" y1="110" x2="590" y2="150" stroke="#7a87ff"/>

        <rect x="470" y="150" width="120" height="60" rx="10" fill="#0f141b" stroke="#4cc2ff"/>
        <text x="530" y="185" text-anchor="middle" fill="#e6edf3" font-size="12">Redis Cache</text>

        <rect x="610" y="150" width="120" height="60" rx="10" fill="#0f141b" stroke="#4cc2ff"/>
        <text x="670" y="185" text-anchor="middle" fill="#e6edf3" font-size="12">ID Gen</text>

        <ellipse cx="800" cy="180" rx="90" ry="50" fill="#0f141b" stroke="#4cc2ff"/>
        <text x="800" y="176" text-anchor="middle" fill="#e6edf3" font-size="12">DB (SQL/NoSQL)</text>
        <text x="800" y="194" text-anchor="middle" fill="#9fb0c3" font-size="10">urls, clicks</text>
      </svg>
      <figcaption>Figure 7. Requests hit CDN/edge, then the API behind a load balancer. Reads are served from cache when possible; writes go through ID generation to storage.</figcaption>
    </figure>

    <section aria-labelledby="s72">
      <h2 id="s72">7.2 Requirements Gathering</h2>
      <ul class="resource-list">
        <li><strong>Functional:</strong> Shorten a long URL → return short code. Redirect short code → original URL (HTTP 301/302). Optional: custom alias, expiration, click analytics.</li>
        <li><strong>Non-functional:</strong> p95 redirect &lt; 50&nbsp;ms, 99.9% <a href="/chapters/glossary.html#availability">availability</a>, low cost per request, simple operations.</li>
        <li><strong>Traffic assumptions (example):</strong> 30M redirects/day (~350 RPS avg, 2–3× peaks); 1M new URLs/day (~12 RPS writes). Read-heavy system.</li>
        <li><strong>Constraints:</strong> Handle bursts gracefully; prevent abusive links; support https redirects.</li>
      </ul>
      <div class="callout warn"><strong>Pitfall:</strong> Forgetting abuse controls (phishing/malware). Add allow/deny lists and safe-browsing checks asynchronously to avoid write-time latency.</div>
    </section>

    <section aria-labelledby="s73">
      <h2 id="s73">7.3 Back-of-the-Envelope Estimations</h2>
      <p>
        Estimation keeps designs honest and guides choices.
      </p>
      <ul class="resource-list">
        <li><strong>Key size:</strong> If we use a 62-character alphabet (a–z, A–Z, 0–9), length 7 yields 62⁷ ≈ 3.5×10¹² unique codes—ample.</li>
        <li><strong>Storage:</strong> Each record ~ (short_code 7B + URL avg 120B + metadata ~80B) ≈ 207B; for 1B URLs → ~207 GB (plus indexes, replication).</li>
        <li><strong>Cache hit goal:</strong> Popular links should be cacheable at CDN and Redis; target 95%+ hit rate on redirects.</li>
      </ul>
      <div class="callout info"><strong>Analogy:</strong> Choosing key length is like picking license plate formats: more characters = more combinations but slightly longer plates.</div>
    </section>

    <section aria-labelledby="s74">
      <h2 id="s74">7.4 API Design</h2>
      <h3>Endpoints</h3>
      <ul class="resource-list">
        <li><code>POST /api/shorten</code> — JSON body: <code>{ url, custom_alias?, ttl? }</code>. Returns <code>{ short_code, short_url }</code>.</li>
        <li><code>GET /{short_code}</code> — Redirect to long URL (301 for permanent, 302 for temporary).</li>
        <li><code>GET /api/stats/{short_code}</code> — (optional) click counts, last_accessed.</li>
      </ul>
      <p>
        Authentication optional for basic service; rate limit by IP or API key to prevent abuse. Use <a href="/chapters/glossary.html#idempotency">idempotency</a> keys for POST requests to avoid duplicate records on retries.
      </p>
    </section>

    <section aria-labelledby="s75">
      <h2 id="s75">7.5 Data Model &amp; Indexes</h2>
      <h3>Relational option (SQL)</h3>
      <pre><code>urls(
  short_code CHAR(7) PRIMARY KEY,
  long_url TEXT NOT NULL,
  created_at TIMESTAMP,
  expires_at TIMESTAMP NULL,
  owner_id NULL,
  flags JSONB  -- malware, blocked, etc.
)

clicks(
  id BIGSERIAL PRIMARY KEY,
  short_code CHAR(7) REFERENCES urls(short_code),
  ts TIMESTAMP,
  ua TEXT, ip INET, country CHAR(2)
)</code></pre>
      <p>
        Indexes: <code>urls(short_code)</code>, <code>urls(expires_at)</code> for cleanup; <code>clicks(short_code, ts DESC)</code> for recent analytics.
      </p>

      <h3>Document option (NoSQL)</h3>
      <pre><code>urls/{short_code} = {
  long_url, created_at, expires_at?, owner_id?, flags:{blocked:false}
}
clicks/{short_code}/{day} = { counts:{total, by_country:{...}} }</code></pre>
      <p>
        Analytical writes aggregate per day to avoid hot partitions. Raw click logs can be batched to object storage for later processing.
      </p>
      <div class="callout danger"><strong>Trade-off:</strong> SQL simplifies uniqueness and transactions for <em>custom aliases</em>. NoSQL scales writes and analytics cheaply but needs careful key selection to avoid hot shards.</div>
    </section>

    <section aria-labelledby="s76">
      <h2 id="s76">7.6 ID Generation</h2>
      <p>
        We can generate short codes in two common ways:
      </p>
      <ul class="resource-list">
        <li><strong>Counter + base-62 encoding:</strong> Increment a global counter (e.g., DB sequence), encode to base-62. Simple and sequential; risk of predictability.</li>
        <li><strong>Random 7-char tokens:</strong> Generate securely random codes and check for collisions. With 62⁷ space, collision probability is low; still check uniqueness.</li>
      </ul>
      <div class="callout info"><strong>Compare &amp; Contrast</strong>
        <ul class="resource-list">
          <li>Counter: deterministic, easier analytics (<em>creation order</em>), but needs coordination or shard-aware sequences.</li>
          <li>Random: no central hot counter, but requires uniqueness check and retry on rare collisions.</li>
        </ul>
      </div>
    </section>

    <section aria-labelledby="s77">
      <h2 id="s77">7.7 Read Path (Redirect)</h2>
      <ol class="resource-list">
        <li>Client requests <code>GET /{short_code}</code> — edge/CDN receives it.</li>
        <li>Edge cache check: if mapping is cached and valid → return 301/302 immediately.</li>
        <li>Otherwise hit app → Redis (<em>cache-aside</em>) for <code>short_code</code> → <code>long_url</code>.</li>
        <li>On miss, query DB, populate Redis (TTL ~1–7 days), optionally push to CDN for hot codes.</li>
        <li>Return redirect; enqueue click metrics to a <a href="/chapters/glossary.html#queue">queue</a> for async processing.</li>
      </ol>
      <div class="callout success"><strong>Case study (≈180 words):</strong> Launch day brings a celebrity tweet with a short link. Traffic jumps to 20k RPS for that code. Because it’s cached at the edge and in Redis, app and DB load barely rise. A bug appears: expired links still redirect for a few minutes. Root cause: CDN TTL too long for expiring entries. Fix: use <em>cache key versioning</em> or <em>surrogate keys</em> that can be purged on expiration events. Lesson: choose TTLs per class of URL (permanent vs. temporary) and support explicit purge.</div>
    </section>

    <section aria-labelledby="s78">
      <h2 id="s78">7.8 Write Path (Shorten)</h2>
      <ol class="resource-list">
        <li>Client POSTs <code>{ url, custom_alias?, ttl? }</code> with an <a href="/chapters/glossary.html#idempotency">idempotency</a> key.</li>
        <li>App validates URL (syntax, size cap), screens via safe-browsing (async if slow).</li>
        <li>Generate code (random or counter), ensure uniqueness, write to DB in transaction.</li>
        <li>Warm caches: set Redis entry; optionally prime CDN with <code>/{short_code}</code> → 301 hint to reduce cold starts.</li>
        <li>Return <code>{ short_code, short_url }</code>. Background job handles malware rechecks and expiration sweeps.</li>
      </ol>
      <div class="callout warn"><strong>Pitfall:</strong> Writing analytics synchronously slows writes. Always enqueue analytics; process in batches.</div>
    </section>

    <section aria-labelledby="s79">
      <h2 id="s79">7.9 Reliability: Redundancy &amp; Failover</h2>
      <ul class="resource-list">
        <li>Run multiple app instances behind a <a href="/chapters/glossary.html#load-balancer">load balancer</a> in at least two availability zones.</li>
        <li>Redis: run a small cluster with replicas and automatic failover; degrade to DB on cache outage with <a href="/chapters/glossary.html#rate-limiting">rate limiting</a>.</li>
        <li>DB: primary with read replicas; regular backups and PITR. For multi-region, start with active–passive and DNS failover.</li>
        <li>Graceful degradation: if malware checker is down, still shorten but mark <em>pending scan</em> and block redirect on known-bad.</li>
      </ul>
    </section>

    <section aria-labelledby="s710">
      <h2 id="s710">7.10 Security &amp; Abuse Handling</h2>
      <ul class="resource-list">
        <li>Sanitize inputs, enforce HTTPS, and set HSTS on redirect domain.</li>
        <li>Block open redirects to <code>javascript:</code> or data URIs; validate schemes (<code>http</code>, <code>https</code>).</li>
        <li>Abuse controls: per-IP rate limits, API keys for bulk use, domain allow/deny lists, user reporting.</li>
        <li>Privacy: avoid storing PII in click logs unless required; aggregate counts by day/country where possible.</li>
      </ul>
    </section>

    <section aria-labelledby="s711">
      <h2 id="s711">7.11 Observability &amp; SLOs</h2>
      <p>
        Define SLIs: p95 redirect latency, success rate, cache hit ratio. SLOs: p95 &lt; 50&nbsp;ms on redirects, success ≥ 99.95%, cache hit ≥ 95% for top 10k codes.
      </p>
      <ul class="resource-list">
        <li>Metrics: per-endpoint latency, Redis hit/miss, DB QPS, queue lag, CDN cache status.</li>
        <li>Tracing: follow <code>GET /{short_code}</code> through edge → app → cache/DB.</li>
        <li>Logging: request ID, short_code, outcome (hit/miss), error causes.</li>
        <li>Alerts: miss ratio spike, p99 &gt; SLO, DB errors, queue backlog.</li>
      </ul>
    </section>

    <section aria-labelledby="s712">
      <h2 id="s712">7.12 Cost &amp; Performance Trade-offs</h2>
      <div class="callout danger"><strong>Trade-off:</strong> Caching at the CDN reduces origin costs but increases complexity for purges and expirations. Without edge caching, origin costs/latency rise. Start with Redis + modest TTL at edge; add explicit purge when expiration/custom-alias become common.</div>
      <p>
        For analytics, aggregate counters per short code per day rather than storing every click synchronously. Batch uploads to data lake for future analysis.
      </p>
    </section>

    <section aria-labelledby="s713">
      <h2 id="s713">7.13 Alternatives Snapshot</h2>
      <table style="width:100%;border-collapse:collapse">
        <thead><tr style="border-bottom:1px solid var(--border)"><th>Component</th><th>Baseline</th><th>Alternative</th><th>When to choose</th></tr></thead>
        <tbody>
          <tr><td>ID generation</td><td>Random 7-char</td><td>Counter + base62</td><td>Need creation ordering or analytics</td></tr>
          <tr><td>Storage</td><td>SQL (single primary + replicas)</td><td>NoSQL (KV/document)</td><td>Massive scale, simple record shape</td></tr>
          <tr><td>Caching</td><td>Redis cache-aside</td><td>Edge/CDN full-page</td><td>Very hot keys, global audience</td></tr>
          <tr><td>Analytics</td><td>Async queue + batch</td><td>Streaming pipeline</td><td>Realtime dashboards required</td></tr>
        </tbody>
      </table>
    </section>

    <section aria-labelledby="resources">
      <h2 id="resources">Resources</h2>
      <ul class="resource-list">
        <li>System Design Primer — URL shortener case study (concept reinforcement).</li>
        <li>(Optional) Grokking System Design Problems — practice prompts and rubrics.</li>
        <li>Vendor docs for your chosen DB, Redis, and CDN — implementation details matter.</li>
      </ul>
    </section>

    <section aria-labelledby="practice">
      <h2 id="practice">Practice</h2>
      <ol class="practice">
        <li><strong>TinyURL design (60–90 min):</strong> Write a 1–2 page design covering requirements, APIs, schema, caches, SLOs, and failure modes. <em>Success:</em> All sections present with at least one explicit trade-off and a diagram.</li>
        <li><strong>Estimate drill (20–30 min):</strong> Recompute RPS, storage, and key length for 10× traffic. <em>Success:</em> New numbers lead to at least one architecture change (e.g., edge caching by default).</li>
        <li><strong>What-if analysis (25–35 min):</strong> Add “custom alias” + “expiration” and update caches/invalidation. <em>Success:</em> A concrete purge strategy (surrogate keys or versioned cache keys).</li>
        <li><strong>Variant sketch (30–40 min):</strong> Redo the design for a <em>chat app</em>. Note protocol change (WebSockets), ordering, and storage differences. <em>Success:</em> Compare/contrast table with ≥5 differences.</li>
      </ol>
    </section>

    <section aria-labelledby="mastery">
      <h2 id="mastery">Mastery Check</h2>
      <ol class="mastery">
        <li><strong>Define:</strong> What makes URL shorteners read-heavy, and how does that affect design?
          <details><summary>Sample answer</summary><p>Redirects dominate vs. writes; prioritize caching (CDN + Redis), fast lookups by short_code, and async analytics. DB is rarely on the hot path after warmup.</p></details>
        </li>
        <li><strong>Explain:</strong> Why use idempotency keys on <code>POST /shorten</code>?
          <details><summary>Sample answer</summary><p>To prevent duplicate records when clients retry due to network issues; server upserts by key to ensure one logical write.</p></details>
        </li>
        <li><strong>Apply:</strong> A link must expire at a precise timestamp. How do you ensure CDN doesn’t serve it after expiry?
          <details><summary>Sample answer</summary><p>Short TTL plus explicit purge via surrogate key on expiration event; or encode version in cache key so expired version misses.</p></details>
        </li>
        <li><strong>Evaluate:</strong> Counter + base62 vs. random IDs—pick one for public links and justify.
          <details><summary>Sample answer</summary><p>Random avoids hot global counters and is harder to enumerate; with collision check it scales well. Choose counter if you need monotonic IDs or sharded sequences for analytics.</p></details>
        </li>
        <li><strong>Explain:</strong> How would you design analytics without slowing redirects?
          <details><summary>Sample answer</summary><p>Emit an event to a queue or log; batch process asynchronously to update daily counters; optional streaming for realtime dashboards.</p></details>
        </li>
        <li><strong>Apply:</strong> Redis fails. What happens and how do you prevent meltdown?
          <details><summary>Sample answer</summary><p>Cache miss storm hits DB; mitigate with request coalescing, jittered backoff, circuit breakers, and temporary rate limits; pre-warm hot keys after recovery.</p></details>
        </li>
        <li><strong>Explain:</strong> Where do you place rate limits and why?
          <details><summary>Sample answer</summary><p>At edge/CDN or API gateway to stop abuse early; per-IP and per-key limits for POST, and per-code burst limits for GET to defend from scraping.</p></details>
        </li>
      </ol>
    </section>

    <section aria-labelledby="recap">
      <h2 id="recap">Recap &amp; Next Steps</h2>
      <p>
        You designed a complete, small system using rigorous steps: requirements, estimates, APIs, data model, caching, scaling, reliability, and observability.  
        In the next chapter, you’ll review pitfalls and plan your path from beginner to intermediate with concrete extensions and study targets.
      </p>
    </section>

    <nav class="next-prev" aria-label="Chapter pagination">
      <a rel="prev" href="chapters/ch06.html" aria-label="Previous: Chapter 6">← Prev</a>
      <a rel="next" href="chapters/ch08.html" aria-label="Next: Chapter 8">Next →</a>
    </nav>

    <footer style="margin-top:2rem;color:var(--muted)">
      <p>End of Chapter 7</p>
    </footer>
  </main>

  <!-- VALIDATION & MAPPING CHECKLIST
  - [x] theme.css+app.js loaded
  - [x] Canonical nav used verbatim; active link correct
  - [x] Pager correct (prev=ch06, next=ch08)
  - [x] ToC order matches file numbering
  - [x] Sections present (objectives/resources/practice/mastery) and meet minimums
  - [x] Glossary links valid
  - [x] Head/meta ok
  - [x] No TODOs
  -- Depth quick checks --
  - [x] Chapter word count ≥ 1,200
  - [x] ≥ 2 examples, ≥ 1 case study, ≥ 1 compare/contrast, ≥ 1 analogy
  - [x] Practice: 3–5 tasks with criteria
  - [x] Mastery: 5–7 Qs with <details> answers
  - [x] ≥ 8 glossary terms introduced; ≥ 1 figure with caption
  -->
</body>
</html>
